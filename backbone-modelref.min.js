// Generated by CoffeeScript 1.3.1
/*
 backbone-modelref.js 0.1.1
 (c) 2011 Kevin Malakoff.
 Backbone-ModelRef.js is freely distributable under the MIT license.
 See the following for full license details:
 https://github.com/kmalakoff/backbone-modelref/blob/master/LICENSE
 Dependencies: Backbone.js and Underscore.js.
*/
var Backbone,_,__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c;d.__super__=b.prototype;return d};_=!this._&&(typeof require!=="undefined")?require("underscore"):this._;Backbone=!this.Backbone&&(typeof require!=="undefined")?require("backbone"):this.Backbone;Backbone.ModelRef=(function(){a.name="ModelRef";function a(i,b,j){var c,g,f,k,d,h,e;this.collection=i;this.model_id=b;this.cached_model=j!=null?j:null;_.bindAll(this,"_checkForLoad","_checkForUnload");if(!this.collection){throw new Error("Backbone.ModelRef: collection is missing")}this.ref_count=1;if(this.collection.retain){this.collection.retain()}if(this.cached_model){this.model_id=this.cached_model.id}if(!this.cached_model&&this.model_id){this.cached_model=this.collection.get(this.model_id)}if(this.cached_model){h=Backbone.ModelRef.MODEL_EVENTS_WHEN_LOADED;for(g=0,k=h.length;g<k;g++){c=h[g];this.collection.bind(c,this._checkForUnload)}}else{e=Backbone.ModelRef.MODEL_EVENTS_WHEN_UNLOADED;for(f=0,d=e.length;f<d;f++){c=e[f];this.collection.bind(c,this._checkForLoad)}}}a.prototype.retain=function(){this.ref_count++;return this};a.prototype.release=function(){var f,h,e,d,c,g,b;if(this.ref_count<=0){throw new Error("Backbone.ModelRef.release(): ref count is corrupt")}this.ref_count--;if(this.ref_count>0){return}if(this.cached_model){g=Backbone.ModelRef.MODEL_EVENTS_WHEN_LOADED;for(h=0,d=g.length;h<d;h++){f=g[h];this.collection.unbind(f,this._checkForUnload)}}else{b=Backbone.ModelRef.MODEL_EVENTS_WHEN_UNLOADED;for(e=0,c=b.length;e<c;e++){f=b[e];this.collection.unbind(f,this._checkForLoad)}}if(this.collection.release){this.collection.release()}this.collection=null;return this};a.prototype.getModel=function(){if(this.cached_model&&!this.cached_model.isNew()){this.model_id=this.cached_model.id}if(this.cached_model){return this.cached_model}if(this.model_id){this.cached_model=this.collection.get(this.model_id)}return this.cached_model};a.prototype._checkForLoad=function(){var g,e,i,f,d,c,h,b;if(this.cached_model||!this.model_id){return}e=this.collection.get(this.model_id);if(!e){return}h=Backbone.ModelRef.MODEL_EVENTS_WHEN_UNLOADED;for(i=0,d=h.length;i<d;i++){g=h[i];this.collection.unbind(g,this._checkForLoad)}b=Backbone.ModelRef.MODEL_EVENTS_WHEN_LOADED;for(f=0,c=b.length;f<c;f++){g=b[f];this.collection.bind(g,this._checkForUnload)}this.cached_model=e;return this.trigger("loaded",this.cached_model)};a.prototype._checkForUnload=function(){var g,e,i,f,d,c,h,b;if(!this.cached_model||!this.model_id){return}e=this.collection.get(this.model_id);if(e){return}h=Backbone.ModelRef.MODEL_EVENTS_WHEN_LOADED;for(i=0,d=h.length;i<d;i++){g=h[i];this.collection.unbind(g,this._checkForUnload)}b=Backbone.ModelRef.MODEL_EVENTS_WHEN_UNLOADED;for(f=0,c=b.length;f<c;f++){g=b[f];this.collection.bind(g,this._checkForLoad)}e=this.cached_model;this.cached_model=null;return this.trigger("unloaded",e)};return a})();__extends(Backbone.ModelRef.prototype,Backbone.Events);Backbone.ModelRef.VERSION="0.1.1";Backbone.ModelRef.MODEL_EVENTS_WHEN_LOADED=["reset","remove"];Backbone.ModelRef.MODEL_EVENTS_WHEN_UNLOADED=["reset","add"];Backbone.Model.prototype.model=function(){if(arguments.length===0){return this}throw new Error("cannot set a Backbone.Model")};Backbone.Model.prototype.isLoaded=function(){return true};Backbone.Model.prototype.bindLoadingStates=function(a){if(_.isFunction(a)){a(this)}else{if(a.loaded){a.loaded(this)}}return this};Backbone.Model.prototype.unbindLoadingStates=function(a){return this};Backbone.ModelRef.prototype.get=function(a){if(a!=="id"){throw new Error("Backbone.ModelRef.get(): only id is permitted")}if(this.cached_model&&!this.cached_model.isNew()){this.model_id=this.cached_model.id}return this.model_id};Backbone.ModelRef.prototype.model=function(n){var m,c,p,k,j,h,f,o,d,b,a,l,i,g,e;if(arguments.length===0){return this.getModel()}if(n&&(n.collection!==this.collection)){throw new Error("Backbone.ModelRef.model(): collections don't match")}m=this.model_id?!n||(this.model_id!==n.get("id")):!!n;if(!m){return}if(this.cached_model){p=this.cached_model;this.model_id=null;this.cached_model=null;l=Backbone.ModelRef.MODEL_EVENTS_WHEN_LOADED;for(k=0,o=l.length;k<o;k++){c=l[k];this.collection.unbind(c,this._checkForUnload)}i=Backbone.ModelRef.MODEL_EVENTS_WHEN_UNLOADED;for(j=0,d=i.length;j<d;j++){c=i[j];this.collection.bind(c,this._checkForLoad)}this.trigger("unloaded",p)}if(!n){return}this.model_id=n.get("id");this.cached_model=n.model();g=Backbone.ModelRef.MODEL_EVENTS_WHEN_UNLOADED;for(h=0,b=g.length;h<b;h++){c=g[h];this.collection.unbind(c,this._checkForLoad)}e=Backbone.ModelRef.MODEL_EVENTS_WHEN_LOADED;for(f=0,a=e.length;f<a;f++){c=e[f];this.collection.bind(c,this._checkForUnload)}return this.trigger("loaded",this.cached_model)};Backbone.ModelRef.prototype.isLoaded=function(){var a;a=this.getModel();if(!a){return false}if(a.isLoaded){return a.isLoaded()}else{return true}};Backbone.ModelRef.prototype.bindLoadingStates=function(b){var a;if(_.isFunction(b)){this.bind("loaded",b)}else{if(b.loaded){this.bind("loaded",b.loaded)}if(b.unloaded){this.bind("unloaded",b.unloaded)}}a=this.model();if(!a){return null}return a.bindLoadingStates(b)};Backbone.ModelRef.prototype.unbindLoadingStates=function(a){if(_.isFunction(a)){this.unbind("loaded",a)}else{if(a.loaded){this.unbind("loaded",a.loaded)}if(a.unloaded){this.unbind("unloaded",a.unloaded)}}return this.model()};