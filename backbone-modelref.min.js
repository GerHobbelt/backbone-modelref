/*
 backbone-modelref.js 0.1.0
 (c) 2011 Kevin Malakoff.
 Backbone-ModelRef.js is freely distributable under the MIT license.
 See the following for full license details:
 https://github.com/kmalakoff/backbone-modelref/blob/master/LICENSE
 Dependencies: Backbone.js and Underscore.js.
*/
var __hasProp=Object.prototype.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c;d.__super__=b.prototype;return d};if(!this.Backbone||!this.Backbone.Model){throw new Error("Backbone.ModelRef: Dependency alert! Backbone.js must be included before this file")}Backbone.ModelRef=(function(){var a,c;a=["reset","remove"];c=["reset","add"];function b(k,j,f){var h,i,g,e,d;this.collection=k;this.model_id=j;this.cached_model=f!=null?f:null;_.bindAll(this,"_checkForLoad","_checkForUnload");if(!this.collection){throw new Error("Backbone.ModelRef: collection is missing")}if(!(this.model_id||this.cached_model)){throw new Error("Backbone.ModelRef: model_id and cached_model missing")}if(this.collection.retain){this.collection.retain()}this.cached_model=this.cached_model||this.collection.get(this.model_id);if(this.cached_model){for(i=0,e=a.length;i<e;i++){h=a[i];this.collection.bind(h,this._checkForUnload)}}else{for(g=0,d=c.length;g<d;g++){h=c[g];this.collection.bind(h,this._checkForLoad)}}this.ref_count=1}b.prototype.retain=function(){this.ref_count++;return this};b.prototype.release=function(){var g,h,f,e,d;if(this.ref_count<=0){throw new Error("Backbone.ModelRef.release(): ref count is corrupt")}this.ref_count--;if(this.ref_count>0){return}if(this.cached_model){for(h=0,e=a.length;h<e;h++){g=a[h];this.collection.unbind(g,this._checkForUnload)}}else{for(f=0,d=c.length;f<d;f++){g=c[f];this.collection.unbind(g,this._checkForLoad)}}if(this.collection.release){this.collection.release()}this.collection=null;return this};b.prototype.getModel=function(){if(this.cached_model&&!this.cached_model.isNew()){this.model_id=this.cached_model.id}if(this.cached_model){return this.cached_model}return this.cached_model=this.collection.get(this.model_id)};b.prototype._checkForLoad=function(){var h,f,i,g,e,d;f=this.collection.get(this.model_id);if(!f){return}if(this.cached_model){return}for(i=0,e=c.length;i<e;i++){h=c[i];this.collection.unbind(h,this._checkForLoad)}for(g=0,d=a.length;g<d;g++){h=a[g];this.collection.bind(h,this._checkForUnload)}this.cached_model=f;return this.trigger("loaded",this.cached_model)};b.prototype._checkForUnload=function(){var h,f,i,g,e,d;f=this.collection.get(this.model_id);if(f){return}if(!this.cached_model){return}for(i=0,e=a.length;i<e;i++){h=a[i];this.collection.unbind(h,this._checkForUnload)}for(g=0,d=c.length;g<d;g++){h=c[g];this.collection.bind(h,this._checkForLoad)}f=this.cached_model;this.cached_model=null;return this.trigger("unloaded",f)};return b})();__extends(Backbone.ModelRef.prototype,Backbone.Events);Backbone.ModelRef.VERSION="0.1.1";Backbone.Model.prototype.model=function(){return this};Backbone.Model.prototype.isLoaded=function(){return true};Backbone.Model.prototype.bindLoadingStates=function(a){if(_.isFunction(a)){a(this)}else{if(a.loaded){a.loaded(this)}}return this};Backbone.Model.prototype.unbindLoadingStates=function(a){return this};Backbone.ModelRef.prototype.get=function(a){if(a!=="id"){throw new Error("Backbone.ModelRef.get(): only id is permitted")}if(this.cached_model&&!this.cached_model.isNew()){this.model_id=this.cached_model.id}return this.model_id};Backbone.ModelRef.prototype.model=function(){return this.getModel()};Backbone.ModelRef.prototype.isLoaded=function(){var a;a=this.getModel();if(!a){return false}if(a.isLoaded){return a.isLoaded()}else{return true}};Backbone.ModelRef.prototype.bindLoadingStates=function(b){var a;if(_.isFunction(b)){this.bind("loaded",b)}else{if(b.loaded){this.bind("loaded",b.loaded)}if(b.unloaded){this.bind("unloaded",b.unloaded)}}a=this.model();if(!a){return null}return a.bindLoadingStates(b)};Backbone.ModelRef.prototype.unbindLoadingStates=function(a){if(_.isFunction(a)){this.unbind("loaded",a)}else{if(a.loaded){this.unbind("loaded",a.loaded)}if(a.unloaded){this.unbind("unloaded",a.unloaded)}}return this.model()};