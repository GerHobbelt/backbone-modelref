/*
 backbone-modelref.js 0.1.0
 (c) 2011 Kevin Malakoff.
 Backbone-ModelRef.js is freely distributable under the MIT license.
 See the following for full license details:
 https://github.com/kmalakoff/backbone-modelref/blob/master/LICENSE
 Dependencies: Backbone.js and Underscore.js.
*/
var __hasProp=Object.prototype.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c;d.__super__=b.prototype;return d};if(!this.Backbone||!this.Backbone.Model){throw new Error("Backbone.ModelRef: Dependency alert! Backbone.js must be included before this file")}Backbone.ModelRef=(function(){function a(i,b,j){var c,g,f,k,d,h,e;this.collection=i;this.model_id=b;this.cached_model=j!=null?j:null;_.bindAll(this,"_checkForLoad","_checkForUnload");if(!this.collection){throw new Error("Backbone.ModelRef: collection is missing")}this.ref_count=1;if(this.collection.retain){this.collection.retain()}if(this.cached_model){this.model_id=this.cached_model.id}if(!this.cached_model&&this.model_id){this.cached_model=this.collection.get(this.model_id)}if(this.cached_model){h=Backbone.ModelRef.MODEL_EVENTS_WHEN_LOADED;for(g=0,k=h.length;g<k;g++){c=h[g];this.collection.bind(c,this._checkForUnload)}}else{e=Backbone.ModelRef.MODEL_EVENTS_WHEN_UNLOADED;for(f=0,d=e.length;f<d;f++){c=e[f];this.collection.bind(c,this._checkForLoad)}}}a.prototype.retain=function(){this.ref_count++;return this};a.prototype.release=function(){var e,g,d,c,b,f,h;if(this.ref_count<=0){throw new Error("Backbone.ModelRef.release(): ref count is corrupt")}this.ref_count--;if(this.ref_count>0){return}if(this.cached_model){f=Backbone.ModelRef.MODEL_EVENTS_WHEN_LOADED;for(g=0,c=f.length;g<c;g++){e=f[g];this.collection.unbind(e,this._checkForUnload)}}else{h=Backbone.ModelRef.MODEL_EVENTS_WHEN_UNLOADED;for(d=0,b=h.length;d<b;d++){e=h[d];this.collection.unbind(e,this._checkForLoad)}}if(this.collection.release){this.collection.release()}this.collection=null;return this};a.prototype.getModel=function(){if(this.cached_model&&!this.cached_model.isNew()){this.model_id=this.cached_model.id}if(this.cached_model){return this.cached_model}if(this.model_id){this.cached_model=this.collection.get(this.model_id)}return this.cached_model};a.prototype._checkForLoad=function(){var f,d,h,e,c,b,g,i;if(this.cached_model||!this.model_id){return}d=this.collection.get(this.model_id);if(!d){return}g=Backbone.ModelRef.MODEL_EVENTS_WHEN_UNLOADED;for(h=0,c=g.length;h<c;h++){f=g[h];this.collection.unbind(f,this._checkForLoad)}i=Backbone.ModelRef.MODEL_EVENTS_WHEN_LOADED;for(e=0,b=i.length;e<b;e++){f=i[e];this.collection.bind(f,this._checkForUnload)}this.cached_model=d;return this.trigger("loaded",this.cached_model)};a.prototype._checkForUnload=function(){var f,d,h,e,c,b,g,i;if(!this.cached_model||!this.model_id){return}d=this.collection.get(this.model_id);if(d){return}g=Backbone.ModelRef.MODEL_EVENTS_WHEN_LOADED;for(h=0,c=g.length;h<c;h++){f=g[h];this.collection.unbind(f,this._checkForUnload)}i=Backbone.ModelRef.MODEL_EVENTS_WHEN_UNLOADED;for(e=0,b=i.length;e<b;e++){f=i[e];this.collection.bind(f,this._checkForLoad)}d=this.cached_model;this.cached_model=null;return this.trigger("unloaded",d)};return a})();__extends(Backbone.ModelRef.prototype,Backbone.Events);Backbone.ModelRef.VERSION="0.1.1";Backbone.ModelRef.MODEL_EVENTS_WHEN_LOADED=["reset","remove"];Backbone.ModelRef.MODEL_EVENTS_WHEN_UNLOADED=["reset","add"];Backbone.Model.prototype.model=function(){if(arguments.length===0){return this}throw new Error("cannot set a Backbone.Model")};Backbone.Model.prototype.isLoaded=function(){return true};Backbone.Model.prototype.bindLoadingStates=function(a){if(_.isFunction(a)){a(this)}else{if(a.loaded){a.loaded(this)}}return this};Backbone.Model.prototype.unbindLoadingStates=function(a){return this};Backbone.ModelRef.prototype.get=function(a){if(a!=="id"){throw new Error("Backbone.ModelRef.get(): only id is permitted")}if(this.cached_model&&!this.cached_model.isNew()){this.model_id=this.cached_model.id}return this.model_id};Backbone.ModelRef.prototype.model=function(m){var l,c,p,j,i,h,f,n,b,a,o,k,g,e,d;if(arguments.length===0){return this.getModel()}if(m&&(m.collection!==this.collection)){throw new Error("Backbone.ModelRef.model(): collections don't match")}l=this.model_id?!m||(this.model_id!==m.get("id")):!!m;if(!l){return}if(this.cached_model){p=this.cached_model;this.model_id=null;this.cached_model=null;k=Backbone.ModelRef.MODEL_EVENTS_WHEN_LOADED;for(j=0,n=k.length;j<n;j++){c=k[j];this.collection.unbind(c,this._checkForUnload)}g=Backbone.ModelRef.MODEL_EVENTS_WHEN_UNLOADED;for(i=0,b=g.length;i<b;i++){c=g[i];this.collection.bind(c,this._checkForLoad)}this.trigger("unloaded",p)}if(!m){return}this.model_id=m.get("id");this.cached_model=m.model();e=Backbone.ModelRef.MODEL_EVENTS_WHEN_UNLOADED;for(h=0,a=e.length;h<a;h++){c=e[h];this.collection.unbind(c,this._checkForLoad)}d=Backbone.ModelRef.MODEL_EVENTS_WHEN_LOADED;for(f=0,o=d.length;f<o;f++){c=d[f];this.collection.bind(c,this._checkForUnload)}return this.trigger("loaded",this.cached_model)};Backbone.ModelRef.prototype.isLoaded=function(){var a;a=this.getModel();if(!a){return false}if(a.isLoaded){return a.isLoaded()}else{return true}};Backbone.ModelRef.prototype.bindLoadingStates=function(b){var a;if(_.isFunction(b)){this.bind("loaded",b)}else{if(b.loaded){this.bind("loaded",b.loaded)}if(b.unloaded){this.bind("unloaded",b.unloaded)}}a=this.model();if(!a){return null}return a.bindLoadingStates(b)};Backbone.ModelRef.prototype.unbindLoadingStates=function(a){if(_.isFunction(a)){this.unbind("loaded",a)}else{if(a.loaded){this.unbind("loaded",a.loaded)}if(a.unloaded){this.unbind("unloaded",a.unloaded)}}return this.model()};